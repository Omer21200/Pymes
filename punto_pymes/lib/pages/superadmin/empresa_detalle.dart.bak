import 'package:flutter/material.dart';
import 'package:google_maps_flutter/google_maps_flutter.dart' as gmaps;
import 'package:intl/intl.dart';
import '../../service/supabase_service.dart';
import '../../theme.dart';

class EmpresaDetallePage extends StatefulWidget {
  final String empresaId;
  final Map<String, dynamic>? initialEmpresa;

  const EmpresaDetallePage({
    super.key,
    required this.empresaId,
    this.initialEmpresa,
  });

  @override
  State<EmpresaDetallePage> createState() => _EmpresaDetallePageState();
}

class _EmpresaDetallePageState extends State<EmpresaDetallePage> {
  Map<String, dynamic>? _empresa;
  bool _loading = true;
  double? _lat;
  double? _lng;
  gmaps.GoogleMapController? _mapController;
  final double _zoom = 15.0;
  // Inline edit state
  bool _editing = false;
  TextEditingController? _nombreCtrl;
  TextEditingController? _rucCtrl;
  TextEditingController? _telefonoCtrl;
  TextEditingController? _correoCtrl;
  TextEditingController? _direccionCtrl;
  double? _editLat;
  double? _editLng;

  @override
  void initState() {
    super.initState();
    if (widget.initialEmpresa != null) {
      _empresa = widget.initialEmpresa;
      _lat = _toDouble(_empresa?['latitud']);
      _lng = _toDouble(_empresa?['longitud']);
      _loading = false;
    }
    _fetch();
  }

  Future<void> _openEditDialog() async {
    if (_empresa == null) return;

    final nombreCtrl = TextEditingController(
      text: _empresa?['nombre']?.toString() ?? '',
    );
    final rucCtrl = TextEditingController(
      text: _empresa?['ruc']?.toString() ?? '',
    );
    final telefonoCtrl = TextEditingController(
      text: _empresa?['telefono']?.toString() ?? '',
    );
    final correoCtrl = TextEditingController(
      text: _empresa?['correo']?.toString() ?? '',
    );
    final direccionCtrl = TextEditingController(
      text: _empresa?['direccion']?.toString() ?? '',
    );

    double? pickedLat = _lat;
    double? pickedLng = _lng;

    await showModalBottomSheet<void>(
      context: context,
      isScrollControlled: true,
      backgroundColor: AppColors.surface,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(16)),
      ),
      builder: (context) {
        return StatefulBuilder(
          builder: (context, setStateModal) {
            return Padding(
              padding: EdgeInsets.only(
                bottom: MediaQuery.of(context).viewInsets.bottom,
                left: 16,
                right: 16,
                top: 16,
              ),
              child: SingleChildScrollView(
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: [
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        const Text(
                          'Editar Empresa',
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.w700,
                          ),
                        ),
                        IconButton(
                          onPressed: () => Navigator.of(context).pop(),
                          icon: const Icon(Icons.close),
                        ),
                      ],
                    ),
                    const SizedBox(height: 8),
                    TextField(
                      controller: nombreCtrl,
                      decoration: const InputDecoration(labelText: 'Nombre'),
                    ),
                    const SizedBox(height: 8),
                    TextField(
                      controller: rucCtrl,
                      decoration: const InputDecoration(labelText: 'RUC'),
                    ),
                    const SizedBox(height: 8),
                    TextField(
                      controller: telefonoCtrl,
                      decoration: const InputDecoration(labelText: 'Teléfono'),
                      keyboardType: TextInputType.phone,
                    ),
                    const SizedBox(height: 8),
                    TextField(
                      controller: correoCtrl,
                      decoration: const InputDecoration(labelText: 'Email'),
                      keyboardType: TextInputType.emailAddress,
                    ),
                    const SizedBox(height: 8),
                    TextField(
                      controller: direccionCtrl,
                      decoration: const InputDecoration(labelText: 'Dirección'),
                    ),
                    const SizedBox(height: 8),
                    Row(
                      children: [
                        Expanded(
                          child: Text(
                            pickedLat != null && pickedLng != null
                                ? 'Ubicación: ${pickedLat!.toStringAsFixed(6)}, ${pickedLng!.toStringAsFixed(6)}'
                                : 'Ubicación: no seleccionada',
                          ),
                        ),
                        const SizedBox(width: 8),
                        ElevatedButton(
                          onPressed: () async {
                            // open a simple map picker dialog
                            final res = await showDialog<gmaps.LatLng?>(
                              context: context,
                              builder: (ctx) {
                                gmaps.LatLng temp =
                                    (pickedLat != null && pickedLng != null)
                                    ? gmaps.LatLng(pickedLat!, pickedLng!)
                                    : (_lat != null && _lng != null)
                                    ? gmaps.LatLng(_lat!, _lng!)
                                    : const gmaps.LatLng(-2.8895, -79.0086);
                                return Dialog(
                                  child: SizedBox(
                                    height: 420,
                                    child: StatefulBuilder(
                                      builder: (ctx2, setStateDialog) {
                                        return Column(
                                          children: [
                                            Expanded(
                                              child: gmaps.GoogleMap(
                                                initialCameraPosition:
                                                    gmaps.CameraPosition(
                                                      target: temp,
                                                      zoom: 14,
                                                    ),
                                                markers: {
                                                  gmaps.Marker(
                                                    markerId:
                                                        const gmaps.MarkerId(
                                                          'edit_marker',
                                                        ),
                                                    position: temp,
                                                    draggable: true,
                                                    onDragEnd: (p) =>
                                                        setStateDialog(
                                                          () => temp =
                                                              gmaps.LatLng(
                                                                p.latitude,
                                                                p.longitude,
                                                              ),
                                                        ),
                                                  ),
                                                },
                                                onTap: (pos) => setStateDialog(
                                                  () => temp = gmaps.LatLng(
                                                    pos.latitude,
                                                    pos.longitude,
                                                  ),
                                                ),
                                                onMapCreated: (c) {},
                                              ),
                                            ),
                                            Padding(
                                              padding: const EdgeInsets.all(
                                                8.0,
                                              ),
                                              child: Row(
                                                mainAxisAlignment:
                                                    MainAxisAlignment.end,
                                                children: [
                                                  TextButton(
                                                    onPressed: () =>
                                                        Navigator.of(
                                                          ctx,
                                                        ).pop(null),
                                                    child: const Text(
                                                      'Cancelar',
                                                    ),
                                                  ),
                                                  const SizedBox(width: 8),
                                                  ElevatedButton(
                                                    onPressed: () =>
                                                        Navigator.of(
                                                          ctx,
                                                        ).pop(temp),
                                                    child: const Text(
                                                      'Seleccionar',
                                                    ),
                                                  ),
                                                ],
                                              ),
                                            ),
                                          ],
                                        );
                                      },
                                    ),
                                  ),
                                );
                              },
                            );
                            if (res != null) {
                              setStateModal(() {
                                pickedLat = res.latitude;
                                pickedLng = res.longitude;
                              });
                            }
                          },
                          child: const Text('Seleccionar ubicación'),
                        ),
                      ],
                    ),
                    const SizedBox(height: 12),
                    Row(
                      children: [
                        Expanded(
                          child: OutlinedButton(
                            onPressed: () => Navigator.of(context).pop(),
                            child: const Text('Cancelar'),
                          ),
                        ),
                        const SizedBox(width: 8),
                        Expanded(
                          child: ElevatedButton(
                            onPressed: () async {
                              // call update
                              final navigator = Navigator.of(context);
                              final messenger = ScaffoldMessenger.of(context);
                              try {
                                final updated = await SupabaseService.instance
                                    .updateEmpresa(
                                      empresaId: widget.empresaId,
                                      nombre: nombreCtrl.text.trim().isNotEmpty
                                          ? nombreCtrl.text.trim()
                                          : null,
                                      ruc: rucCtrl.text.trim().isNotEmpty
                                          ? rucCtrl.text.trim()
                                          : null,
                                      telefono:
                                          telefonoCtrl.text.trim().isNotEmpty
                                          ? telefonoCtrl.text.trim()
                                          : null,
                                      correo: correoCtrl.text.trim().isNotEmpty
                                          ? correoCtrl.text.trim()
                                          : null,
                                      direccion:
                                          direccionCtrl.text.trim().isNotEmpty
                                          ? direccionCtrl.text.trim()
                                          : null,
                                      latitud: pickedLat,
                                      longitud: pickedLng,
                                    );
                                if (!mounted) return;
                                if (updated != null) {
                                  setState(() {
                                    _empresa = updated;
                                    _lat = _toDouble(updated['latitud']);
                                    _lng = _toDouble(updated['longitud']);
                                  });
                                }
                                navigator.pop();
                              } catch (e) {
                                if (!mounted) return;
                                messenger.showSnackBar(
                                  SnackBar(
                                    content: Text('Error al actualizar: $e'),
                                  ),
                                );
                              }
                            },
                            child: const Text('Guardar'),
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 12),
                  ],
                ),
              ),
            );
          },
        );
      },
    );

    // dispose controllers
    nombreCtrl.dispose();
    rucCtrl.dispose();
    telefonoCtrl.dispose();
    correoCtrl.dispose();
    direccionCtrl.dispose();
  }

  void _startEditing() {
    if (_empresa == null) return;
    setState(() {
      _editing = true;
      _nombreCtrl = TextEditingController(
        text: _empresa?['nombre']?.toString() ?? '',
      );
      _rucCtrl = TextEditingController(
        text: _empresa?['ruc']?.toString() ?? '',
      );
      _telefonoCtrl = TextEditingController(
        text: _empresa?['telefono']?.toString() ?? '',
      );
      _correoCtrl = TextEditingController(
        text: _empresa?['correo']?.toString() ?? '',
      );
      _direccionCtrl = TextEditingController(
        text: _empresa?['direccion']?.toString() ?? '',
      );
      _editLat = _lat;
      _editLng = _lng;
    });
  }

  void _cancelEditing() {
    setState(() {
      _editing = false;
    });
    _nombreCtrl?.dispose();
    _rucCtrl?.dispose();
    _telefonoCtrl?.dispose();
    _correoCtrl?.dispose();
    _direccionCtrl?.dispose();
    _nombreCtrl = null;
    _rucCtrl = null;
    _telefonoCtrl = null;
    _correoCtrl = null;
    _direccionCtrl = null;
    _editLat = null;
    _editLng = null;
  }

  Future<void> _saveEditing() async {
    if (!_editing) return;
    final navigator = Navigator.of(context);
    final messenger = ScaffoldMessenger.of(context);
    try {
      final updated = await SupabaseService.instance.updateEmpresa(
        empresaId: widget.empresaId,
        nombre: _nombreCtrl?.text.trim().isNotEmpty == true
            ? _nombreCtrl!.text.trim()
            : null,
        ruc: _rucCtrl?.text.trim().isNotEmpty == true
            ? _rucCtrl!.text.trim()
            : null,
        telefono: _telefonoCtrl?.text.trim().isNotEmpty == true
            ? _telefonoCtrl!.text.trim()
            : null,
        correo: _correoCtrl?.text.trim().isNotEmpty == true
            ? _correoCtrl!.text.trim()
            : null,
        direccion: _direccionCtrl?.text.trim().isNotEmpty == true
            ? _direccionCtrl!.text.trim()
            : null,
        latitud: _editLat,
        longitud: _editLng,
      );
      if (!mounted) return;
      if (updated != null) {
        setState(() {
          _empresa = updated;
          _lat = _toDouble(updated['latitud']);
          _lng = _toDouble(updated['longitud']);
          _editing = false;
        });
      } else {
        setState(() => _editing = false);
      }
    } catch (e) {
      if (!mounted) return;
      messenger.showSnackBar(SnackBar(content: Text('Error al guardar: $e')));
    } finally {
      _nombreCtrl?.dispose();
      _rucCtrl?.dispose();
      _telefonoCtrl?.dispose();
      _correoCtrl?.dispose();
      _direccionCtrl?.dispose();
      _nombreCtrl = null;
      _rucCtrl = null;
      _telefonoCtrl = null;
      _correoCtrl = null;
      _direccionCtrl = null;
      _editLat = null;
      _editLng = null;
    }
  }

  double? _toDouble(Object? v) {
    if (v == null) return null;
    if (v is num) return v.toDouble();
    return double.tryParse(v.toString());
  }

  Future<void> _fetch() async {
    setState(() => _loading = true);
    try {
      final data = await SupabaseService.instance.getEmpresaById(
        widget.empresaId,
      );
      if (data != null) {
        _empresa = data;
        _lat = _toDouble(data['latitud']);
        _lng = _toDouble(data['longitud']);
      }
    } catch (_) {}
    if (mounted) setState(() => _loading = false);
  }

  double _determineCompanyRadiusMeters() {
    double radiusMeters = 50.0;
    if (_empresa != null) {
      final radiusCandidates = [
        'allowed_radius_m',
        'radius_m',
        'radio',
        'geofence_radius',
        'rango',
        'radius',
      ];
      for (final k in radiusCandidates) {
        final rv = _empresa?[k];
        if (rv != null) {
          final parsed = rv is num
              ? rv.toDouble()
              : double.tryParse(rv.toString());
          if (parsed != null && parsed > 0) {
            radiusMeters = parsed;
            break;
          }
        }
      }
    }
    return radiusMeters;
  }

  void _centerMap() {
    if (_mapController == null || _lat == null || _lng == null) return;
    try {
      _mapController!.animateCamera(
        gmaps.CameraUpdate.newLatLngZoom(gmaps.LatLng(_lat!, _lng!), _zoom),
      );
    } catch (_) {}
  }

  Widget _detailRow(
    String label,
    Object? value, {
    Widget? trailing,
    IconData? icon,
  }) {
    final text = value?.toString() ?? '—';
    return Container(
      margin: const EdgeInsets.symmetric(vertical: 6),
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
      decoration: BoxDecoration(
        color: AppColors.surfaceSoft,
        borderRadius: BorderRadius.circular(12),
      ),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.center,
        children: [
          if (icon != null) ...[
            Icon(icon, color: AppColors.mutedGray),
            const SizedBox(width: 12),
          ],
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  label,
                  style: TextStyle(
                    fontSize: 13,
                    color: AppColors.mutedGray,
                    fontWeight: FontWeight.w600,
                  ),
                ),
                const SizedBox(height: 6),
                SelectableText(
                  text,
                  style: const TextStyle(
                    fontSize: 15,
                    color: Colors.black87,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ],
            ),
          ),
          if (trailing != null) ...[const SizedBox(width: 8), trailing],
        ],
      ),
    );
  }

  Widget _editableRow(
    String label,
    TextEditingController controller, {
    IconData? icon,
    String? hint,
  }) {
    return Container(
      margin: const EdgeInsets.symmetric(vertical: 6),
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
      decoration: BoxDecoration(
        color: AppColors.surfaceSoft,
        borderRadius: BorderRadius.circular(12),
      ),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.center,
        children: [
          if (icon != null) ...[
            Icon(icon, color: AppColors.mutedGray),
            const SizedBox(width: 12),
          ],
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  label,
                  style: TextStyle(
                    fontSize: 13,
                    color: AppColors.mutedGray,
                    fontWeight: FontWeight.w600,
                  ),
                ),
                const SizedBox(height: 6),
                TextField(
                  controller: controller,
                  decoration: InputDecoration(hintText: hint),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  String _formatCreated(Object? created) {
    if (created == null) return '—';
    try {
      // Accept strings like '2026-01-19 04:14:41.068034' or ISO formats
      final s = created.toString();
      DateTime dt;
      if (s.contains(' ')) {
        dt = DateTime.parse(s.replaceFirst(' ', 'T'));
      } else {
        dt = DateTime.parse(s);
      }
      return DateFormat('dd/MM/yyyy HH:mm').format(dt.toLocal());
    } catch (_) {
      return created.toString();
    }
  }

  @override
  void dispose() {
    _nombreCtrl?.dispose();
    _rucCtrl?.dispose();
    _telefonoCtrl?.dispose();
    _correoCtrl?.dispose();
    _direccionCtrl?.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Theme.of(context).scaffoldBackgroundColor,
      appBar: AppBar(
        title: const Text('Detalle de Empresa'),
        backgroundColor: AppColors.primary,
      ),
      body: SafeArea(
        child: _loading
            ? const Center(child: CircularProgressIndicator())
            : SingleChildScrollView(
                padding: const EdgeInsets.all(16),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: [
                    Text(
                      _empresa?['nombre']?.toString() ?? 'Empresa',
                      style: const TextStyle(
                        fontSize: 20,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(height: 12),

                    // Prominent access code card — shown first and visually distinct
                    _accessCodeCard(),

                    const SizedBox(height: 8),
                    Card(
                      color: AppColors.surface,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                      elevation: 2,
                      child: Padding(
                        padding: const EdgeInsets.all(12.0),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.stretch,
                          children: [
                            if (_empresa?['empresa_foto_url'] != null) ...[
                              InkWell(
                                onTap: () {
                                  showDialog(
                                    context: context,
                                    builder: (_) => Dialog(
                                      insetPadding: const EdgeInsets.all(8),
                                      child: InteractiveViewer(
                                        child: Image.network(
                                          _empresa!['empresa_foto_url'],
                                          fit: BoxFit.contain,
                                        ),
                                      ),
                                    ),
                                  );
                                },
                                child: ClipRRect(
                                  borderRadius: BorderRadius.circular(8),
                                  child: Image.network(
                                    _empresa!['empresa_foto_url'],
                                    height: 150,
                                    width: double.infinity,
                                    fit: BoxFit.cover,
                                  ),
                                ),
                              ),
                              const SizedBox(height: 12),
                            ],

                            // Details list (styled like a form with icons)
                            // Editable details: switch between read-only and inline fields
                            if (_editing) ...[
                              _editableRow(
                                'RUC',
                                _rucCtrl!,
                                icon: Icons.receipt_long,
                              ),
                              _editableRow(
                                'Teléfono',
                                _telefonoCtrl!,
                                icon: Icons.phone,
                              ),
                              _editableRow(
                                'Email',
                                _correoCtrl!,
                                icon: Icons.email,
                              ),
                              _editableRow(
                                'Dirección',
                                _direccionCtrl!,
                                icon: Icons.location_on,
                              ),
                            ] else ...[
                              _detailRow(
                                'RUC',
                                _empresa?['ruc'] ?? _empresa?['ruc_empresa'],
                                icon: Icons.receipt_long,
                              ),
                              _detailRow(
                                'Teléfono',
                                _empresa?['telefono'],
                                icon: Icons.phone,
                              ),
                              _detailRow(
                                'Email',
                                _empresa?['correo'] ?? _empresa?['email'],
                                icon: Icons.email,
                              ),
                              _detailRow(
                                'Dirección',
                                _empresa?['direccion'],
                                icon: Icons.location_on,
                              ),
                            ],
                            // Lat/Lng hidden here (map shows coordinates)
                            _detailRow(
                              'Creado',
                              _formatCreated(
                                _empresa?['created_at'] ??
                                    _empresa?['createdAt'],
                              ),
                              icon: Icons.calendar_today,
                            ),
                            const SizedBox(height: 12),
                            SizedBox(
                              height: 260,
                              child:
                                  (_editing
                                      ? (_editLat != null && _editLng != null)
                                      : (_lat != null && _lng != null))
                                  ? ClipRRect(
                                      borderRadius: BorderRadius.circular(12),
                                      child: gmaps.GoogleMap(
                                        initialCameraPosition:
                                            gmaps.CameraPosition(
                                              target: gmaps.LatLng(
                                                _editing
                                                    ? (_editLat ?? -2.8895)
                                                    : (_lat ?? -2.8895),
                                                _editing
                                                    ? (_editLng ?? -79.0086)
                                                    : (_lng ?? -79.0086),
                                              ),
                                              zoom: _zoom,
                                            ),
                                        markers: {
                                          gmaps.Marker(
                                            markerId: const gmaps.MarkerId(
                                              'company',
                                            ),
                                            position: gmaps.LatLng(
                                              _editing
                                                  ? (_editLat ?? -2.8895)
                                                  : (_lat ?? -2.8895),
                                              _editing
                                                  ? (_editLng ?? -79.0086)
                                                  : (_lng ?? -79.0086),
                                            ),
                                            draggable: _editing,
                                            onDragEnd: _editing
                                                ? (p) => setState(() {
                                                    _editLat = p.latitude;
                                                    _editLng = p.longitude;
                                                  })
                                                : null,
                                          ),
                                        },
                                        circles: _editing
                                            ? {}
                                            : {
                                                gmaps.Circle(
                                                  circleId:
                                                      const gmaps.CircleId(
                                                        'company_radius',
                                                      ),
                                                  center: gmaps.LatLng(
                                                    _lat ?? 0,
                                                    _lng ?? 0,
                                                  ),
                                                  radius:
                                                      _determineCompanyRadiusMeters(),
                                                  fillColor:
                                                      const Color.fromRGBO(
                                                        33,
                                                        150,
                                                        243,
                                                        0.12,
                                                      ),
                                                  strokeColor: Colors.blue,
                                                  strokeWidth: 2,
                                                ),
                                              },
                                        onMapCreated: (c) => _mapController = c,
                                        onTap: _editing
                                            ? (pos) => setState(() {
                                                _editLat = pos.latitude;
                                                _editLng = pos.longitude;
                                              })
                                            : null,
                                        myLocationButtonEnabled: false,
                                        zoomControlsEnabled: false,
                                      ),
                                    )
                                  : Center(
                                      child: Text(
                                        'No hay coordenadas',
                                        style: AppTextStyles.smallLabel
                                            .copyWith(
                                              color: AppColors.mutedGray,
                                            ),
                                      ),
                                    ),
                            ),
                            const SizedBox(height: 12),
                            Row(
                              mainAxisAlignment: MainAxisAlignment.end,
                              children: [
                                ElevatedButton.icon(
                                  onPressed: _centerMap,
                                  icon: const Icon(Icons.my_location),
                                  label: const Text('Centrar'),
                                  style: ElevatedButton.styleFrom(
                                    backgroundColor: AppColors.primary,
                                    foregroundColor: Colors.white,
                                  ),
                                ),
                                const SizedBox(width: 8),
                                if (!_editing) ...[
                                  ElevatedButton.icon(
                                    onPressed: _startEditing,
                                    icon: const Icon(Icons.edit),
                                    label: const Text('Editar'),
                                    style: ElevatedButton.styleFrom(
                                      backgroundColor: AppColors.primary,
                                      foregroundColor: Colors.white,
                                    ),
                                  ),
                                ] else ...[
                                  OutlinedButton(
                                    onPressed: _cancelEditing,
                                    child: const Text('Cancelar'),
                                    style: OutlinedButton.styleFrom(
                                      backgroundColor: AppColors.primary,
                                      foregroundColor: Colors.white,
                                    ),
                                  ),
                                  const SizedBox(width: 8),
                                  ElevatedButton(
                                    onPressed: _saveEditing,
                                    child: const Text('Guardar'),
                                    style: ElevatedButton.styleFrom(
                                      backgroundColor: AppColors.primary,
                                      foregroundColor: Colors.white,
                                    ),
                                  ),
                                ],
                              ],
                            ),
                          ],
                        ),
                      ),
                    ),
                  ],
                ),
              ),
      ),
    );
  }

  Widget _accessCodeCard() {
    final code =
        _empresa?['codigo_acceso_empleado'] ??
        _empresa?['codigoAcceso'] ??
        _empresa?['codigo_acceso'];
    if (code == null) return const SizedBox.shrink();
    final text = code.toString();
    return Card(
      color: Colors.white,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      elevation: 3,
      child: Padding(
        padding: const EdgeInsets.all(12.0),
        child: Row(
          children: [
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    'Código de acceso',
                    style: TextStyle(
                      fontWeight: FontWeight.w700,
                      color: AppColors.primary,
                    ),
                  ),
                  const SizedBox(height: 8),
                  SelectableText(
                    text,
                    style: const TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.w800,
                    ),
                  ),
                ],
              ),
            ),
            // copy button removed per UX request
          ],
        ),
      ),
    );
  }
}
